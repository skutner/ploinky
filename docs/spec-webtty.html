<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebTTY Specification - Ploinky</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">ğŸš€</div>
                    <span>Ploinky</span>
                </a>
                <nav>
                    <ul>
                        <li><a href="index.html">Home</a></li>
                        <li><a href="cli-reference.html">CLI Reference</a></li>
                        <li><a href="spec-services.html">Services</a></li>
                        <li><a href="spec-webtty.html" class="active">WebTTY</a></li>
                        <li><a href="spec-cli.html">CLI Spec</a></li>
                        <li><button class="theme-toggle" id="themeToggle">ğŸŒ™</button></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="doc-layout">
                <aside class="sidebar">
                    <h3>WebTTY Components</h3>
                    <ul>
                        <li><a href="#overview">Overview</a></li>
                        <li><a href="#security">Token Security</a></li>
                        <li><a href="#server">Server Architecture</a></li>
                        <li><a href="#websocket">WebSocket Protocol</a></li>
                        <li><a href="#tty">TTY Management</a></li>
                        <li><a href="#console">Console Interface</a></li>
                        <li><a href="#chat">Chat Interface</a></li>
                        <li><a href="#dashboard">Dashboard Interface</a></li>
                    </ul>
                </aside>

                <div class="content-wrapper">
                    <div class="doc-section">
                        <h1>WebTTY Specification</h1>
                        <p class="subtitle">Technical documentation for Ploinky's web terminal, chat, and dashboard services.</p>
                    </div>

                    <div class="doc-section" id="overview">
                        <h2>Overview</h2>
                        <p>WebTTY provides web-based interfaces for interacting with CLI tools and managing Ploinky workspaces. It includes three main components:</p>
                        
                        <ul style="margin-left: 2rem;">
                            <li><strong>WebConsole:</strong> Full terminal emulator in the browser</li>
                            <li><strong>WebChat:</strong> Chat-style interface for CLI programs</li>
                            <li><strong>Dashboard:</strong> Management interface for agents and configuration</li>
                        </ul>

                        <h3>Architecture</h3>
                        <pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Browser Client                 â”‚
â”‚  (xterm.js / Chat UI / Dashboard UI)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
            WebSocket (ws://)
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WebTTY Server (Node.js)          â”‚
â”‚  (HTTP Server + WebSocket Handler)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
               PTY Interface
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Command Process (bash, python, etc)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
                    </div>

                    <div class="doc-section" id="security">
                        <h2>Token-Based Security</h2>
                        <p>WebTTY uses secure token-based authentication. When you start a service, it generates a unique token and provides a secure access link.</p>
                        
                        <h3>Token Generation</h3>
                        <pre><code>// When starting WebTTY/WebChat/Dashboard
ploinky webchat

// Output:
[webchat] Starting chat interface...
âœ… WebChat available at:
http://localhost:8080/?token=a7b3c9d2e5f8g1h4i6j8k0l2m4n6o8p0q2r4s6t8

// Token is generated from:
crypto.randomBytes(32).toString('hex')</code></pre>

                        <h3>Token Storage</h3>
                        <pre><code>// Tokens are stored in .ploinky/.secrets
WEBCHAT_TOKEN=a7b3c9d2e5f8g1h4i6j8k0l2m4n6o8p0q2r4s6t8
WEBTTY_TOKEN=b8c4d0e3f6g9h2i5j7k9l1m3n5o7p9q1r3s5t7u9
WEBDASHBOARD_TOKEN=c9d5e1f4g7h0i3j6k8l0m2n4o6p8q0r2s4t6u8v0

// Tokens persist across sessions
// Same token = same access link</code></pre>

                        <h3>Authentication Flow</h3>
                        <pre><code>1. User starts service â†’ Token generated/retrieved
2. Server starts with token validation middleware
3. User accesses URL without token â†’ Redirected to error
4. User accesses URL with valid token â†’ Session created
5. WebSocket connection authenticated with session
6. All subsequent requests validated against session</code></pre>

                        <h3>Security Features</h3>
                        <ul style="margin-left: 2rem;">
                            <li>âœ… Cryptographically secure 256-bit tokens</li>
                            <li>âœ… Token never displayed after initial generation</li>
                            <li>âœ… Session-based authentication after initial token</li>
                            <li>âœ… No passwords stored or transmitted</li>
                            <li>âœ… Tokens unique per service type</li>
                            <li>âœ… HTTPS recommended for production</li>
                        </ul>
                    </div>

                    <div class="doc-section" id="server">
                        <h2>Server Architecture</h2>
                        <p><strong>File:</strong> <code>cli/webtty/server.js</code></p>
                        
                        <h3>Server Implementation</h3>
                        <pre><code>function startWebTTYServer(options) {
    const {
        port,
        ttyFactory,
        mode,        // 'console', 'chat', or 'dashboard'
        title,
        workdir
    } = options;
    
    // Generate or retrieve token
    const token = getOrCreateToken(mode);
    
    // Create Express app
    const app = express();
    
    // Token validation middleware
    app.use((req, res, next) => {
        const urlToken = req.query.token;
        const sessionToken = req.session?.token;
        
        if (urlToken === token) {
            req.session.token = token;
            next();
        } else if (sessionToken === token) {
            next();
        } else {
            res.status(401).send('Invalid token');
        }
    });
    
    // Serve appropriate UI
    app.get('/', (req, res) => {
        switch(mode) {
            case 'console':
                res.send(getConsoleHTML());
                break;
            case 'chat':
                res.send(getChatHTML());
                break;
            case 'dashboard':
                res.send(getDashboardHTML());
                break;
        }
    });
    
    // WebSocket handling
    const server = http.createServer(app);
    const wss = new WebSocketServer({ server });
    
    wss.on('connection', (ws, req) => {
        // Validate WebSocket connection
        if (!validateWebSocketAuth(req)) {
            ws.close(1008, 'Unauthorized');
            return;
        }
        
        // Create PTY for console/chat modes
        if (mode !== 'dashboard') {
            const pty = ttyFactory.create();
            bindPtyToWebSocket(pty, ws);
        }
    });
    
    server.listen(port, () => {
        console.log(`âœ… ${mode} available at:`);
        console.log(`http://localhost:${port}/?token=${token}`);
    });
    
    return server;
}</code></pre>

                        <h3>Token Management</h3>
                        <pre><code>function getOrCreateToken(mode) {
    const tokenVar = {
        'console': 'WEBTTY_TOKEN',
        'chat': 'WEBCHAT_TOKEN',
        'dashboard': 'WEBDASHBOARD_TOKEN'
    }[mode];
    
    // Check if token exists
    let token = env.resolveVarValue(tokenVar);
    
    if (!token || !token.trim()) {
        // Generate new token
        token = crypto.randomBytes(32).toString('hex');
        env.setEnvVar(tokenVar, token);
    }
    
    return token;
}</code></pre>
                    </div>

                    <div class="doc-section" id="websocket">
                        <h2>WebSocket Protocol</h2>
                        <p>Real-time bidirectional communication between browser and server.</p>
                        
                        <h3>Message Types</h3>
                        <pre><code>// Client â†’ Server
{ type: 'input', data: 'user typed text' }
{ type: 'resize', cols: 80, rows: 24 }
{ type: 'ping' }

// Server â†’ Client
{ type: 'output', data: 'program output' }
{ type: 'exit', code: 0 }
{ type: 'error', message: 'Error details' }
{ type: 'pong' }</code></pre>

                        <h3>WebSocket Handler</h3>
                        <pre><code>function bindPtyToWebSocket(pty, ws) {
    // PTY output â†’ WebSocket
    pty.on('data', (data) => {
        ws.send(JSON.stringify({
            type: 'output',
            data: data
        }));
    });
    
    // WebSocket â†’ PTY input
    ws.on('message', (message) => {
        const msg = JSON.parse(message);
        
        switch(msg.type) {
            case 'input':
                pty.write(msg.data);
                break;
            case 'resize':
                pty.resize(msg.cols, msg.rows);
                break;
            case 'ping':
                ws.send(JSON.stringify({ type: 'pong' }));
                break;
        }
    });
    
    // Cleanup on disconnect
    ws.on('close', () => {
        pty.kill();
    });
    
    pty.on('exit', (code) => {
        ws.send(JSON.stringify({ type: 'exit', code }));
        ws.close();
    });
}</code></pre>
                    </div>

                    <div class="doc-section" id="tty">
                        <h2>TTY Management</h2>
                        <p><strong>File:</strong> <code>cli/webtty/tty.js</code></p>
                        
                        <h3>PTY Factory</h3>
                        <pre><code>function createLocalTTYFactory({ ptyLib, workdir, command }) {
    return {
        create: () => {
            const shell = command || process.env.SHELL || '/bin/bash';
            
            const pty = ptyLib.spawn(shell, [], {
                name: 'xterm-256color',
                cols: 80,
                rows: 24,
                cwd: workdir,
                env: {
                    ...process.env,
                    TERM: 'xterm-256color',
                    COLORTERM: 'truecolor'
                }
            });
            
            return {
                on: (event, handler) => pty.on(event, handler),
                write: (data) => pty.write(data),
                resize: (cols, rows) => pty.resize(cols, rows),
                kill: () => pty.kill(),
                pid: pty.pid
            };
        }
    };
}

// Container TTY Factory
function createContainerTTYFactory({ runtime, containerName, command }) {
    return {
        create: () => {
            const args = [
                'exec', '-it',
                containerName,
                ...command.split(' ')
            ];
            
            const pty = ptyLib.spawn(runtime, args, {
                name: 'xterm-256color',
                cols: 80,
                rows: 24
            });
            
            return wrapPty(pty);
        }
    };
}</code></pre>
                    </div>

                    <div class="doc-section" id="console">
                        <h2>Console Interface</h2>
                        <p><strong>File:</strong> <code>cli/webtty/console.js</code></p>
                        
                        <h3>Terminal UI</h3>
                        <pre><code>// Initialize xterm.js terminal
const term = new Terminal({
    cursorBlink: true,
    fontSize: 14,
    fontFamily: 'Cascadia Code, Monaco, monospace',
    theme: {
        background: '#1e1e1e',
        foreground: '#d4d4d4',
        cursor: '#ffffff',
        selection: 'rgba(255, 255, 255, 0.3)'
    }
});

// Attach to DOM
term.open(document.getElementById('terminal'));

// Fit addon for responsive sizing
const fitAddon = new FitAddon.FitAddon();
term.loadAddon(fitAddon);
fitAddon.fit();

// WebSocket connection
const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
const ws = new WebSocket(`${protocol}//${location.host}/ws`);

// Bind terminal to WebSocket
term.onData(data => {
    ws.send(JSON.stringify({ type: 'input', data }));
});

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'output') {
        term.write(msg.data);
    }
};

// Handle resize
window.addEventListener('resize', () => {
    fitAddon.fit();
    ws.send(JSON.stringify({
        type: 'resize',
        cols: term.cols,
        rows: term.rows
    }));
});</code></pre>
                    </div>

                    <div class="doc-section" id="chat">
                        <h2>Chat Interface</h2>
                        <p><strong>File:</strong> <code>cli/webtty/chat.js</code></p>
                        
                        <h3>Chat Implementation</h3>
                        <pre><code>// Message handling
function addServerMessage(text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'wa-message in';
    
    const bubble = document.createElement('div');
    bubble.className = 'wa-message-bubble';
    
    const textDiv = document.createElement('div');
    textDiv.className = 'wa-message-text';
    textDiv.textContent = text;
    
    const timeSpan = document.createElement('span');
    timeSpan.className = 'wa-message-time';
    timeSpan.textContent = formatTime();
    
    bubble.appendChild(textDiv);
    bubble.appendChild(timeSpan);
    msgDiv.appendChild(bubble);
    
    chatList.appendChild(msgDiv);
    chatList.scrollTop = chatList.scrollHeight;
}

// Send user message
function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;
    
    // Add to UI
    addClientMessage(text);
    
    // Send via WebSocket
    ws.send(JSON.stringify({
        type: 'input',
        data: text + '\n'
    }));
    
    inputField.value = '';
}

// Receive output
ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'output') {
        // Accumulate output and display
        outputBuffer += msg.data;
        
        // Split by newlines for chat bubbles
        const lines = outputBuffer.split('\n');
        if (lines.length > 1) {
            const complete = lines.slice(0, -1).join('\n');
            if (complete) {
                addServerMessage(complete);
            }
            outputBuffer = lines[lines.length - 1];
        }
    }
};</code></pre>

                        <h3>WhatsApp-Style Features</h3>
                        <ul style="margin-left: 2rem;">
                            <li>Message bubbles with timestamps</li>
                            <li>Read receipts visualization</li>
                            <li>Auto-resize input field</li>
                            <li>Side panel for long messages</li>
                            <li>Theme switching (light/dark)</li>
                            <li>Connection status indicator</li>
                        </ul>
                    </div>

                    <div class="doc-section" id="dashboard">
                        <h2>Dashboard Interface</h2>
                        <p><strong>Files:</strong> <code>dashboard/*.js</code></p>
                        
                        <h3>Dashboard Components</h3>
                        <pre><code>// Landing Page
landingPage.js     // Main dashboard view
â”œâ”€â”€ Agent status cards
â”œâ”€â”€ Workspace configuration
â”œâ”€â”€ Quick actions
â””â”€â”€ System health

// Authentication
auth.js            // Token validation
â”œâ”€â”€ Session management
â””â”€â”€ Access control

// Repository Management
repositories.js    // Repo CRUD operations
â”œâ”€â”€ Add/remove repos
â”œâ”€â”€ Enable/disable
â””â”€â”€ Agent listings

// Configuration
configurations.js  // Settings management
â”œâ”€â”€ Environment variables
â”œâ”€â”€ Port configuration
â””â”€â”€ Service settings

// Observability
observability.js   // Monitoring views
â”œâ”€â”€ Container status
â”œâ”€â”€ Log viewing
â”œâ”€â”€ Performance metrics
â””â”€â”€ Health checks</code></pre>

                        <h3>Dashboard API</h3>
                        <pre><code>// Dashboard backend endpoints
app.get('/mcp/agents', (req, res) => {
    const agents = workspace.loadAgents();
    res.json(agents);
});

app.get('/mcp/status/:agent', async (req, res) => {
    const status = await getAgentStatus(req.params.agent);
    res.json(status);
});

app.post('/mcp/agents/:agent/restart', async (req, res) => {
    await restartAgent(req.params.agent);
    res.json({ success: true });
});

app.get('/mcp/logs/:service', (req, res) => {
    const logs = readLogs(req.params.service);
    res.json({ logs });
});</code></pre>
                    </div>

                    <div class="doc-section">
                        <h2>Client Integration</h2>
                        
                        <h3>Dynamic UI Loading</h3>
                        <p><strong>File:</strong> <code>cli/webtty/clientloader.js</code></p>
                        <pre><code>// Dynamically load appropriate UI based on mode
function loadInterface(mode) {
    switch(mode) {
        case 'console':
            loadScript('/xterm.js');
            loadScript('/xterm-addon-fit.js');
            loadScript('/console.js');
            loadCSS('/xterm.css');
            break;
            
        case 'chat':
            loadScript('/chat.js');
            loadCSS('/chat.css');
            break;
            
        case 'dashboard':
            loadScript('/dashboard.js');
            loadCSS('/dashboard.css');
            break;
    }
}

// Script loader with promise
function loadScript(src) {
    return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
    });
}</code></pre>

                        <h3>Login Flow</h3>
                        <p><strong>File:</strong> <code>cli/webtty/login.js</code></p>
                        <pre><code>// Check token on page load
window.addEventListener('DOMContentLoaded', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (!token) {
        showError('Access denied. No token provided.');
        return;
    }
    
    // Validate token
    const response = await fetch('/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
    });
    
    if (response.ok) {
        // Token valid, load interface
        loadInterface(mode);
    } else {
        showError('Invalid or expired token.');
    }
});</code></pre>
                    </div>

                    <div class="doc-section">
                        <h2>Configuration</h2>
                        
                        <h3>Port Configuration</h3>
                        <pre><code># Set custom ports
ploinky var WEBTTY_PORT 9001
ploinky var WEBCHAT_PORT 8080
ploinky var WEBDASHBOARD_PORT 9000

# Ports are used on next start</code></pre>

                        <h3>Title Customization</h3>
                        <pre><code># Set custom title
ploinky var WEBTTY_TITLE "Production Console"
ploinky var APP_NAME "MyProject"

# Reflected in UI</code></pre>

                        <h3>Admin Mode</h3>
                        <pre><code># Start all services together
ploinky admin-mode

# Starts:
- Console on WEBTTY_PORT (9001)
- Chat on WEBCHAT_PORT (8080)
- Dashboard on WEBDASHBOARD_PORT (9000)

# Each with its own token:
Console: http://localhost:9001/?token=abc...
Chat: http://localhost:8080/?token=def...
Dashboard: http://localhost:9000/?token=ghi...</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Ploinky Project. Built with security and simplicity in mind.</p>
            <p>
                <a href="https://github.com/ploinky/ploinky">GitHub</a> â€¢ 
                <a href="index.html">Home</a> â€¢ 
                <a href="cli-reference.html">CLI Reference</a>
            </p>
        </div>
    </footer>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', savedTheme);
        themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            themeToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
        });

        // Highlight active section
        const sections = document.querySelectorAll('.doc-section[id]');
        const navLinks = document.querySelectorAll('.sidebar a');
        
        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const rect = section.getBoundingClientRect();
                if (rect.top <= 100) {
                    current = section.getAttribute('id');
                }
            });
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${current}`) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>
