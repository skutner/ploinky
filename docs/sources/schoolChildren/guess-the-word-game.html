<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#ff9a9e" />
  <title>Guess the Word - Kids Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700&family=Nunito:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#ff9a9e;
      --bg2:#fad0c4;
      --bg3:#fbc2eb;
      --bg4:#a18cd1;
      --card:#ffffffee;
      --primary:#ff6f61;
      --secondary:#4dd0e1;
      --accent:#ffd166;
      --success:#34c759;
      --danger:#ff3b30;
      --text:#263238;
      --muted:#90a4ae;
      --tile:#ffffff;
      --tile-border:#e6ecf1;
      --btn:#ffffff;
      --shadow:0 10px 25px rgba(0,0,0,.10);
      --radius:22px;
      --touch:64px;
      --focus:#7c3aed;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Baloo 2", system-ui, -apple-system, Segoe UI, Nunito, Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4));
      background-size: 300% 300%;
      animation: bgMove 20s ease infinite;
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color: transparent;
    }

    @keyframes bgMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    .app{
      width:min(980px, 96vw);
      margin:auto;
      padding:clamp(14px, 2.6vw, 28px);
      padding-bottom: max(14px, env(safe-area-inset-bottom));
    }

    .card{
      background:var(--card);
      border-radius: clamp(18px, 3vw, 28px);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      padding:clamp(16px, 4vw, 34px);
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }

    .confetti-layer{
      position:absolute; inset:0; pointer-events:none; overflow:visible;
    }

    header{
      text-align:center;
      margin-bottom:clamp(14px, 2.8vw, 24px);
    }
    h1{
      margin:0;
      font-size:clamp(28px, 6.5vw, 52px);
      line-height:1.05;
      letter-spacing:1px;
      background:linear-gradient(90deg, #ff6f61, #ff9f1c, #4dd0e1, #7b61ff);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-shadow: 0 2px 0 #ffffffaa;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.4em;
    }
    h1 .emoji{filter: drop-shadow(0 3px 0 rgba(255,255,255,.6))}
    .subtitle{
      font-family:"Nunito", sans-serif;
      margin:10px auto 0;
      font-weight:800;
      font-size:clamp(16px, 3.7vw, 22px);
      color:#2b2b2b;
    }

    .hud{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:12px;
      margin:clamp(10px, 2.4vw, 18px) 0;
    }
    .message{
      grid-column: 1 / -1;
      text-align:center;
      background:linear-gradient(90deg, #fff8e1, #fffbea);
      border:2px dashed #ffe082;
      color:#6d4c41;
      border-radius: 18px;
      padding:10px 14px;
      font-size:clamp(16px, 3.6vw, 20px);
      font-weight:800;
      letter-spacing:.3px;
    }
    .score, .lives, .audio{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:800;
      font-size:clamp(16px, 3.6vw, 20px);
    }
    .badge{
      padding:6px 12px;
      background:#ffffff;
      border-radius:999px;
      box-shadow: var(--shadow);
      display:flex; align-items:center; gap:8px;
    }
    .lives .heart{
      width:clamp(22px, 5.6vw, 32px);
      height:clamp(22px, 5.6vw, 32px);
      display:inline-grid; place-items:center;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ff8a80, #ff3b30);
      color:white;
      box-shadow: 0 4px 10px rgba(255,59,48,.3);
      transform-origin:center;
      animation: heartbeat 1.2s ease-in-out infinite;
    }
    .lives .heart.lost{
      filter: grayscale(1) brightness(.9);
      background: #e0e0e0;
      color:#b0bec5;
      animation:none;
      transform: scale(.9);
      opacity:.75;
    }
    @keyframes heartbeat{
      0%, 28%, 100% {transform: scale(1)}
      14% {transform: scale(1.15)}
    }

    .word-area{
      text-align:center;
      margin:clamp(10px, 3vw, 24px) 0;
    }
    #word-display{
      display:flex;
      justify-content:center;
      flex-wrap:wrap;
      gap: clamp(6px, 2vw, 12px);
      padding: 8px 0;
      min-height: clamp(72px, 16vw, 110px);
    }
    .tile{
      min-width:clamp(40px, 9vw, 70px);
      height:clamp(52px, 12vw, 84px);
      border-radius: 16px;
      background: radial-gradient(120% 120% at 20% 15%, #fff, #f6f9fc 55%, #eaf1f8);
      border:2px solid var(--tile-border);
      box-shadow: 0 8px 0 #e6edf5, 0 0 0 6px #ffffff inset;
      display:grid; place-items:center;
      font-size:clamp(22px, 6.5vw, 44px);
      font-weight:800;
      color:#1f2937;
      position:relative;
      letter-spacing:1px;
      transition: transform .25s ease, box-shadow .25s ease;
    }
    .tile.unknown::after{
      content:"_";
      color:#90a4ae;
      position:absolute;
      bottom:10px;
      left:0; right:0;
      font-size:clamp(18px, 4.8vw, 28px);
    }
    .tile.revealed{
      animation: popIn .45s cubic-bezier(.17,.67,.32,1.35);
      box-shadow: 0 10px 0 #d7e7f7, 0 0 0 6px #ffffff inset, 0 0 16px rgba(125, 211, 252, .45);
    }
    @keyframes popIn{
      0%{transform: translateY(14px) scale(.7) rotate(-3deg); opacity:.2}
      60%{transform: translateY(-6px) scale(1.1)}
      100%{transform: translateY(0) scale(1); opacity:1}
    }

    .keyboard{
      margin-top:clamp(8px, 2.6vw, 14px);
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:clamp(6px, 2vw, 14px);
    }
    .key{
      position:relative;
      height:var(--touch);
      min-width:var(--touch);
      border:none;
      border-radius: 16px;
      font-size: clamp(18px, 4.6vw, 26px);
      font-weight:800;
      color:#263238;
      background:
        radial-gradient(180px 180px at 20% 15%, #ffffff, #f1f5f9),
        linear-gradient(180deg, #ffffff, #f1f5f9);
      box-shadow: 0 8px 0 #dce5ee, 0 0 0 4px #ffffff inset;
      cursor:pointer;
      transition: transform .05s ease, filter .2s ease, background .2s ease;
      touch-action: manipulation;
      overflow:hidden;
      user-select:none;
    }
    .key:active{ transform: translateY(2px) }
    .key.correct{
      background:linear-gradient(180deg, #b2ffb2, #8aff8a);
      box-shadow: 0 8px 0 #7bd77b, 0 0 0 4px #ffffff inset;
      color:#0b5f0b;
      animation: correctPulse .4s ease;
    }
    @keyframes correctPulse{
      0%{transform: scale(1)}
      50%{transform: scale(1.12)}
      100%{transform: scale(1)}
    }
    .key.wrong{
      background:linear-gradient(180deg, #ffd5d5, #ffb3b3);
      box-shadow: 0 8px 0 #f39797, 0 0 0 4px #ffffff inset;
      color:#7a0e0e;
      animation: shake .25s ease both;
    }
    .key:disabled{
      opacity:.65; cursor:not-allowed; filter: saturate(.6);
    }
    @keyframes shake{
      0%{transform: translateX(0)}
      25%{transform: translateX(-5px)}
      50%{transform: translateX(5px)}
      75%{transform: translateX(-3px)}
      100%{transform: translateX(0)}
    }

    /* Tap ripple effect */
    .key::after{
      content:'';
      position:absolute;
      left:var(--x,50%); top:var(--y,50%);
      transform:translate(-50%, -50%) scale(0);
      width:10px; height:10px; border-radius:50%;
      background: var(--ripColor, rgba(59,130,246,.3));
      opacity:0;
      transition: transform .45s ease, opacity .6s ease;
      pointer-events:none;
    }
    .key.ripple::after{
      transform:translate(-50%,-50%) scale(18);
      opacity:1;
    }

    .controls{
      margin-top:clamp(12px, 3.2vw, 18px);
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .btn{
      min-height:var(--touch);
      padding:0 18px;
      border:none;
      border-radius: 18px;
      font-size: clamp(18px, 4.6vw, 24px);
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:10px;
      background: linear-gradient(180deg, #fff, #f3f7ff);
      color:#1f2937;
      box-shadow: 0 10px 0 #d9e6fb;
      cursor:pointer;
      touch-action: manipulation;
      user-select:none;
    }
    .btn:active{ transform: translateY(2px) }
    .btn.primary{
      background: linear-gradient(180deg, #ffcf6f, #ffb22d);
      box-shadow: 0 10px 0 #d5921f;
      color:#5b3a00;
    }
    .btn.secondary{
      background: linear-gradient(180deg, #a5f3fc, #38bdf8);
      box-shadow: 0 10px 0 #0ea5e9;
      color:#053a4a;
    }
    .btn.toggle{
      min-height:auto; padding:8px 12px; border-radius:14px;
      background: linear-gradient(180deg, #fff, #f7fafc);
      box-shadow: 0 6px 0 #e4eefb;
      font-size: clamp(14px, 3.6vw, 18px);
      gap:6px;
    }
    .btn.toggle[aria-pressed="false"] .icon{ filter: grayscale(.8) opacity(.8) }
    .btn.toggle:focus-visible, .key:focus-visible, .btn:focus-visible{
      outline: 3px solid var(--focus);
      outline-offset: 2px;
    }

    .sr-only{
      position:absolute!important;
      height:1px;width:1px;
      overflow:hidden; clip:rect(1px,1px,1px,1px);
      white-space:nowrap; border:0; padding:0; margin:-1px;
    }

    .result-modal{
      position: fixed;
      inset:0;
      display:grid;
      place-items:center;
      background:rgba(0,0,0,.25);
      opacity:0; visibility:hidden;
      transition: .25s ease;
      z-index:30;
      padding: 18px;
    }
    .result-modal.show{
      opacity:1; visibility:visible;
    }
    .result-card{
      width:min(680px, 96vw);
      background:linear-gradient(180deg, #ffffff, #f6fbff);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 22px;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .result-card h2{
      margin:10px 0 8px;
      font-size: clamp(26px, 7vw, 40px);
    }
    .result-word{
      font-size: clamp(22px, 6vw, 32px);
      font-weight:900;
      color:#374151;
      margin-bottom: 12px;
    }
    .result-emoji{
      font-size: clamp(36px, 12vw, 64px);
    }

    .float-bubble{
      position:absolute;
      width:80px;height:80px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ffffffaa, #ffffff00);
      border:2px solid #ffffff55;
      animation: float 12s ease-in-out infinite;
      pointer-events:none;
      z-index:0;
    }
    .float-bubble.b1{ top:-20px; left: -10px; animation-duration: 16s }
    .float-bubble.b2{ bottom:-30px; right: -10px; animation-duration: 20s }
    .float-bubble.b3{ top: 40%; right:-20px; animation-duration: 14s }
    @keyframes float{
      0%,100% { transform: translateY(0) translateX(0) }
      50% { transform: translateY(-16px) translateX(8px) }
    }

    @media (min-width: 620px){
      .keyboard{ grid-template-columns: repeat(9, 1fr) }
      .badge{ padding:8px 14px }
    }

    /* Reduced motion respects */
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:.01ms !important; animation-iteration-count:1 !important; transition-duration:.01ms !important; scroll-behavior:auto !important }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" role="application" aria-label="Guess the word game">
      <div class="confetti-layer" id="confetti" aria-hidden="true"></div>

      <span class="float-bubble b1"></span>
      <span class="float-bubble b2"></span>
      <span class="float-bubble b3"></span>

      <header>
        <h1><span class="emoji" aria-hidden="true">üéà</span> Guess the Word <span class="emoji" aria-hidden="true">üî§</span></h1>
        <div class="subtitle">Tap the letters to find the hidden word! üåü</div>
      </header>

      <div class="hud">
        <div class="score badge" id="streakBadge" aria-live="polite" title="Winning streak">
          <span aria-hidden="true">‚≠ê</span>
          <span>Streak: <strong id="streak">0</strong></span>
        </div>

        <div class="message" id="message" role="status" aria-live="polite">Good luck, word wizard! üßô‚Äç‚ôÇÔ∏è‚ú®</div>

        <div class="audio badge">
          <button class="btn toggle" id="soundToggle" aria-pressed="true" aria-label="Toggle sound effects">
            <span class="icon" id="soundIcon" aria-hidden="true">üîä</span>
            <span class="lbl" id="soundLabel">Sound</span>
          </button>
          <button class="btn toggle" id="vibeToggle" aria-pressed="true" aria-label="Toggle vibration">
            <span class="icon" aria-hidden="true">üì≥</span>
            <span class="lbl">Vibrate</span>
          </button>
        </div>

        <div class="lives badge" id="lives" aria-label="Lives"></div>
      </div>

      <div class="word-area" aria-label="Word">
        <div id="word-display" aria-live="polite"></div>
      </div>

      <div class="keyboard" id="keyboard" role="group" aria-label="Letters keyboard"></div>

      <div class="controls">
        <button class="btn secondary" id="newWordBtn" aria-label="New word">
          <span aria-hidden="true">üîÑ</span> New Word
        </button>
        <button class="btn primary" id="replayBtn" aria-label="Play again">
          <span aria-hidden="true">‚ñ∂Ô∏è</span> Play Again
        </button>
      </div>

      <input class="sr-only" id="hidden-input" autocomplete="off" autocapitalize="none" spellcheck="false" inputmode="none" />

    </div>
  </div>

  <div class="result-modal" id="resultModal" aria-hidden="true" aria-label="Result">
    <div class="result-card" role="dialog" aria-modal="true">
      <div class="result-emoji" id="resultEmoji">üéâ</div>
      <h2 id="resultTitle">You Win!</h2>
      <div class="result-word">The word was: <strong id="resultWord">apple</strong></div>
      <div class="controls" style="justify-content:center;">
        <button class="btn primary" id="playNextBtn"><span aria-hidden="true">üëâ</span> Next Word</button>
        <button class="btn secondary" id="closeModalBtn"><span aria-hidden="true">‚ùå</span> Close</button>
      </div>
    </div>
  </div>

  <script>
    // Game Data
    const words = [
      'apple','banana','orange','grape','strawberry','melon','peach','lemon','mango','pear','cherry','kiwi',
      'cookie','panda','tiger','zebra','rabbit','happy','sunny','smile','rainbow','balloon','puzzle','rocket'
    ];

    // Preferences & Utilities
    const prefersReduced = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches || false;
    const storage = {
      get(key, fallback){ try{ const v = localStorage.getItem(key); return v===null?fallback:JSON.parse(v) }catch{ return fallback } },
      set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)) }catch{} }
    };

    // Sound Effects using WebAudio
    class SFX {
      constructor(){
        this.ctx = null;
        this.master = null;
        this.enabled = storage.get('sfxEnabled', true);
        this.vol = 0.6;
      }
      ensureCtx(){
        if(this.ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return;
        this.ctx = new AC();
        this.master = this.ctx.createGain();
        this.master.gain.value = this.enabled ? this.vol : 0;
        this.master.connect(this.ctx.destination);
      }
      async resume(){
        this.ensureCtx();
        if(this.ctx && this.ctx.state === 'suspended'){
          try{ await this.ctx.resume(); }catch{}
        }
      }
      setEnabled(on){
        this.enabled = on;
        storage.set('sfxEnabled', !!on);
        if(this.master){
          this.master.gain.setTargetAtTime(on?this.vol:0, this.ctx.currentTime, 0.01);
        }
      }
      play(type){
        if(!this.enabled) return;
        this.ensureCtx();
        if(!this.ctx) return;
        const t0 = this.ctx.currentTime + 0.01;

        const env = (gain, a=0.01, d=0.15, s=0.0001)=> {
          gain.gain.cancelScheduledValues(t0);
          gain.gain.setValueAtTime(0.0001, t0);
          gain.gain.exponentialRampToValueAtTime(1, t0 + a);
          gain.gain.exponentialRampToValueAtTime(s, t0 + a + d);
        };
        const osc = (type, freq, dur, vol=.25, detune=0)=> {
          const o = this.ctx.createOscillator();
          const g = this.ctx.createGain();
          o.type = type; o.frequency.value = freq; o.detune.value = detune;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(this.master);
          env(g, 0.01, dur, 0.0001);
          o.start(t0);
          o.stop(t0 + dur + 0.2);
          return {o,g};
        };

        switch(type){
          case 'tap':
            osc('triangle', 520, 0.07);
            break;
          case 'correct':
            osc('sine', 660, 0.16);
            osc('sine', 880, 0.18, .2, 8);
            break;
          case 'wrong':
            osc('sawtooth', 180, 0.22);
            osc('sawtooth', 120, 0.24, .25, -10);
            break;
          case 'win':
            // small arpeggio
            const seq = [523,659,784,988];
            seq.forEach((f, i)=>{
              const start = t0 + i*0.1;
              const o = this.ctx.createOscillator();
              const g = this.ctx.createGain();
              o.type = 'sine'; o.frequency.value = f;
              g.gain.value = 0.0001;
              o.connect(g); g.connect(this.master);
              g.gain.setValueAtTime(0.0001, start);
              g.gain.exponentialRampToValueAtTime(.8, start+0.03);
              g.gain.exponentialRampToValueAtTime(0.0001, start+0.2);
              o.start(start);
              o.stop(start+0.25);
            });
            break;
          case 'lose':
            // descending
            const tones = [392,330,262];
            tones.forEach((f, i)=>{
              const start = t0 + i*0.15;
              const o = this.ctx.createOscillator();
              const g = this.ctx.createGain();
              o.type = 'triangle'; o.frequency.value = f;
              g.gain.value = 0.0001;
              o.connect(g); g.connect(this.master);
              g.gain.setValueAtTime(0.0001, start);
              g.gain.exponentialRampToValueAtTime(.7, start+0.03);
              g.gain.exponentialRampToValueAtTime(0.0001, start+0.25);
              o.start(start);
              o.stop(start+0.28);
            });
            break;
          case 'ui':
            osc('triangle', 420, 0.1);
            break;
        }
      }
    }
    const sfx = new SFX();

    // Haptics
    const haptics = {
      enabled: storage.get('vibeEnabled', true),
      light(){ if(this.enabled && 'vibrate' in navigator) navigator.vibrate(20) },
      medium(){ if(this.enabled && 'vibrate' in navigator) navigator.vibrate([20,40,20]) },
      heavy(){ if(this.enabled && 'vibrate' in navigator) navigator.vibrate([40,60,40]) },
      set(on){ this.enabled = on; storage.set('vibeEnabled', !!on) }
    };

    // State
    let currentWord = '';
    let guessed = new Set();
    let wrongGuesses = 0;
    let maxGuesses = 6;
    let streak = storage.get('streak', 0);
    let lastGuessLetter = '';
    let inputLocked = false;

    // Elements
    const wordDisplay = document.getElementById('word-display');
    const keyboard = document.getElementById('keyboard');
    const messageEl = document.getElementById('message');
    const livesEl = document.getElementById('lives');
    const newWordBtn = document.getElementById('newWordBtn');
    const replayBtn = document.getElementById('replayBtn');
    const hiddenInput = document.getElementById('hidden-input');

    const resultModal = document.getElementById('resultModal');
    const resultEmoji = document.getElementById('resultEmoji');
    const resultTitle = document.getElementById('resultTitle');
    const resultWord = document.getElementById('resultWord');
    const playNextBtn = document.getElementById('playNextBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    const confettiLayer = document.getElementById('confetti');
    const streakEl = document.getElementById('streak');

    const soundToggle = document.getElementById('soundToggle');
    const soundIcon = document.getElementById('soundIcon');
    const soundLabel = document.getElementById('soundLabel');
    const vibeToggle = document.getElementById('vibeToggle');

    // Helpers
    const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('');

    function sampleWord(){
      return words[Math.floor(Math.random() * words.length)];
    }

    function resetState(){
      currentWord = sampleWord();
      guessed = new Set();
      wrongGuesses = 0;
      maxGuesses = 6;
      lastGuessLetter = '';
      inputLocked = false;
      updateUI(true);
      focusHiddenInput();
    }

    function updateUI(isNew=false){
      renderLives();
      renderWord(isNew);
      renderKeyboard(isNew);
      setMessage(isNew ? 'New word! Ready... set... guess! üöÄ' : messageEl.textContent);
      streakEl.textContent = String(streak);
    }

    function renderLives(){
      livesEl.innerHTML = '';
      const livesFrag = document.createDocumentFragment();
      for(let i=0;i<maxGuesses;i++){
        const heart = document.createElement('span');
        const alive = i < maxGuesses - wrongGuesses;
        heart.className = 'heart' + (alive ? '' : ' lost');
        heart.setAttribute('role','img');
        heart.setAttribute('aria-label', alive ? 'life' : 'lost life');
        heart.textContent = alive ? '‚ù§Ô∏è' : 'ü©∂';
        livesFrag.appendChild(heart);
      }
      livesEl.appendChild(livesFrag);
    }

    function renderWord(isNew){
      wordDisplay.innerHTML = '';
      const chars = currentWord.split('');
      const frag = document.createDocumentFragment();
      chars.forEach((ch) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        const revealed = guessed.has(ch);
        tile.textContent = revealed ? ch.toUpperCase() : '';
        if(revealed){
          if(ch === lastGuessLetter && !isNew){
            tile.classList.add('revealed');
          }
        } else {
          tile.classList.add('unknown');
        }
        frag.appendChild(tile);
      });
      wordDisplay.appendChild(frag);
    }

    function renderKeyboard(isNew){
      if(isNew || !keyboard.children.length){
        keyboard.innerHTML = '';
        const frag = document.createDocumentFragment();
        alphabet.forEach(letter=>{
          const btn = document.createElement('button');
          btn.className = 'key';
          btn.type = 'button';
          btn.textContent = letter.toUpperCase();
          btn.setAttribute('data-letter', letter);
          btn.setAttribute('aria-label', `Letter ${letter}`);
          btn.style.userSelect = 'none';
          frag.appendChild(btn);
        });
        keyboard.appendChild(frag);
      }
      [...keyboard.children].forEach(btn=>{
        const l = btn.getAttribute('data-letter');
        btn.disabled = guessed.has(l) || isGameOver();
        btn.classList.remove('correct','wrong');
      });
    }

    function setMessage(text){
      if(!text) return;
      messageEl.textContent = text;
    }

    function isGameOver(){
      return wrongGuesses >= maxGuesses || currentWord.split('').every(ch => guessed.has(ch));
    }

    function rippleAt(btn, e, color){
      const rect = btn.getBoundingClientRect();
      const x = (e?.clientX ?? (rect.left + rect.width/2)) - rect.left;
      const y = (e?.clientY ?? (rect.top + rect.height/2)) - rect.top;
      btn.style.setProperty('--x', x + 'px');
      btn.style.setProperty('--y', y + 'px');
      btn.style.setProperty('--ripColor', color);
      btn.classList.remove('ripple'); // restart
      void btn.offsetWidth;
      btn.classList.add('ripple');
      setTimeout(()=>btn.classList.remove('ripple'), 450);
    }

    function guessLetter(letter, evt){
      if(!letter || isGameOver() || inputLocked) return;
      letter = letter.toLowerCase();
      if(!/^[a-z]$/.test(letter)) return;
      if(guessed.has(letter)) return;

      guessed.add(letter);
      lastGuessLetter = letter;

      const keyBtn = keyboard.querySelector(`[data-letter="${letter}"]`);
      const isCorrect = currentWord.includes(letter);

      if(isCorrect){
        keyBtn && keyBtn.classList.add('correct');
        rippleAt(keyBtn, evt, 'rgba(34,197,94,.35)');
        setMessage(randomGoodJob());
        if(!prefersReduced){ burstEmojis('‚ú®üåüüéà', 12, wordDisplay); }
        sfx.play('correct');
        haptics.light();
      }else{
        wrongGuesses++;
        keyBtn && keyBtn.classList.add('wrong');
        rippleAt(keyBtn, evt, 'rgba(239,68,68,.35)');
        setMessage(randomTryAgain());
        shake(keyboard);
        sfx.play('wrong');
        haptics.medium();
      }

      renderLives();
      renderWord();
      disableUsedKey(letter);
      checkGameStatus();
    }

    function disableUsedKey(letter){
      const btn = keyboard.querySelector(`[data-letter="${letter}"]`);
      if(btn) btn.disabled = true;
    }

    function checkGameStatus(){
      const won = currentWord.split('').every(ch => guessed.has(ch));
      const lost = wrongGuesses >= maxGuesses;

      if(won){
        inputLocked = true;
        streak++;
        storage.set('streak', streak);
        streakEl.textContent = String(streak);
        showResult(true);
        if(!prefersReduced){ makeConfetti(100); }
        sfx.play('win');
        haptics.light();
      } else if(lost){
        inputLocked = true;
        streak = 0;
        storage.set('streak', 0);
        streakEl.textContent = '0';
        showResult(false);
        sfx.play('lose');
        haptics.heavy();
      }
    }

    function showResult(won){
      resultEmoji.textContent = won ? 'üéâ' : 'üß©';
      resultTitle.textContent = won ? 'You did it! üéâ' : 'Good try! üí™';
      resultWord.textContent = currentWord.toUpperCase();
      resultModal.classList.add('show');
      resultModal.setAttribute('aria-hidden','false');
      [...keyboard.children].forEach(btn=> btn.disabled = true);
    }

    function closeResult(){
      resultModal.classList.remove('show');
      resultModal.setAttribute('aria-hidden','true');
    }

    function makeConfetti(count=60){
      const colors = ['#ff6f61','#ffb703','#4dd0e1','#90be6d','#f72585','#3a86ff','#ffd166'];
      for(let i=0;i<count;i++){
        const conf = document.createElement('span');
        conf.style.position='absolute';
        conf.style.top='-10px';
        conf.style.left = Math.random()*100 + '%';
        const size = 6 + Math.random()*8;
        conf.style.width = conf.style.height = size + 'px';
        conf.style.background = colors[Math.floor(Math.random()*colors.length)];
        conf.style.transform = `rotate(${Math.random()*360}deg)`;
        conf.style.borderRadius = Math.random()>.6 ? '50%' : '4px';
        conf.style.opacity = '0.95';
        conf.style.willChange = 'transform, top, opacity';
        confettiLayer.appendChild(conf);
        confettiFall(conf, 1200 + Math.random()*900).then(()=> conf.remove());
      }
    }

    function confettiFall(el, duration){
      return new Promise(res=>{
        const start = performance.now();
        const wobble = 40 + Math.random()*60;
        const rotStart = Math.random()*360;
        function frame(now){
          const t = Math.min(1, (now - start)/duration);
          const ease = t<.5 ? 2*t*t : -1+(4-2*t)*t;
          el.style.top = (ease*100) + '%';
          el.style.transform = `translateX(${Math.sin(t*Math.PI*2)*wobble}px) rotate(${rotStart + t*720}deg)`;
          el.style.opacity = String(1 - t*.8);
          if(t<1) requestAnimationFrame(frame);
          else res();
        }
        requestAnimationFrame(frame);
      });
    }

    function burstEmojis(chars, count, anchorEl){
      const arr = [...chars];
      const rect = anchorEl.getBoundingClientRect();
      const baseX = rect.left + rect.width/2;
      const baseY = rect.top + rect.height/2 + window.scrollY;
      for(let i=0;i<count;i++){
        const span = document.createElement('span');
        span.textContent = arr[i % arr.length];
        span.style.position='fixed';
        span.style.left = baseX + 'px';
        span.style.top = baseY + 'px';
        span.style.zIndex = 25;
        span.style.fontSize = (16 + Math.random()*18) + 'px';
        span.style.pointerEvents='none';
        document.body.appendChild(span);

        const ang = Math.random()*Math.PI*2;
        const dist = 40 + Math.random()*80;
        const dx = Math.cos(ang)*dist;
        const dy = Math.sin(ang)*dist - 20;
        const dur = 500 + Math.random()*500;

        const start = performance.now();
        function anim(now){
          const t = Math.min(1, (now - start)/dur);
          const ease = 1 - Math.pow(1-t, 2);
          span.style.transform = `translate(${dx*ease}px, ${dy*ease}px) scale(${1.2 - .6*ease})`;
          span.style.opacity = String(1 - ease);
          if(t<1) requestAnimationFrame(anim);
          else span.remove();
        }
        requestAnimationFrame(anim);
      }
    }

    function shake(el){
      el.style.animation = 'shake .25s ease';
      el.addEventListener('animationend', ()=> el.style.animation = '', {once:true});
    }

    function randomGoodJob(){
      const msgs = [
        'Yay! You found a letter! ‚úÖ',
        'Awesome! Keep going! üåü',
        'Great guess! üéØ',
        'Woohoo! Nice one! ü•≥',
        'Brilliant! üí°'
      ];
      return msgs[Math.floor(Math.random()*msgs.length)];
    }

    function randomTryAgain(){
      const msgs = [
        'Oops! Try another letter! ‚ùå',
        'Not this time. You got it! üí™',
        'Keep trying! You can do it! üöÄ',
        'Close! Pick a new one! üîç',
        'Don‚Äôt give up! üåà'
      ];
      return msgs[Math.floor(Math.random()*msgs.length)];
    }

    // Events: Keyboard & Touch-friendly pointer input
    keyboard.addEventListener('pointerdown', async (e)=>{
      const btn = e.target.closest('.key');
      if(!btn || btn.disabled) return;
      await sfx.resume();
      sfx.play('tap');
      // ripple will be colored when result known inside guessLetter
    }, {passive:true});

    keyboard.addEventListener('pointerup', (e)=>{
      const btn = e.target.closest('.key');
      if(!btn || btn.disabled) return;
      const letter = btn.getAttribute('data-letter');
      guessLetter(letter, e);
    });

    keyboard.addEventListener('click', (e)=>{
      // Fallback in case pointer events not supported
      const btn = e.target.closest('.key');
      if(!btn || btn.disabled) return;
      const letter = btn.getAttribute('data-letter');
      guessLetter(letter, e);
    });

    newWordBtn.addEventListener('click', async ()=>{
      await sfx.resume(); sfx.play('ui');
      streak = 0; storage.set('streak', 0); streakEl.textContent = '0';
      closeResult();
      resetState();
      setMessage('Fresh start! New word loaded üîÑ');
    });

    replayBtn.addEventListener('click', async ()=>{
      await sfx.resume(); sfx.play('ui');
      closeResult();
      resetState();
      setMessage('Let‚Äôs play again! ‚ñ∂Ô∏è');
    });

    playNextBtn.addEventListener('click', async ()=>{
      await sfx.resume(); sfx.play('ui');
      closeResult();
      resetState();
      setMessage('Next word coming up! üéÅ');
    });

    closeModalBtn.addEventListener('click', ()=>{
      closeResult();
    });

    // Dismiss modal on backdrop tap
    resultModal.addEventListener('click', (e)=>{
      if(e.target === resultModal) closeResult();
    });

    // Keyboard support
    document.addEventListener('keydown', (e)=>{
      if(resultModal.classList.contains('show')){
        if(e.key === 'Enter'){ playNextBtn.click(); }
        if(e.key === 'Escape'){ closeModalBtn.click(); }
        return;
      }
      const key = e.key.toLowerCase();
      if(/^[a-z]$/.test(key)){
        guessLetter(key);
      }else if(e.key === 'Enter'){
        focusHiddenInput();
      }
    });

    // Toggle Sound & Vibration
    function updateSoundUI(){
      soundToggle.setAttribute('aria-pressed', sfx.enabled ? 'true' : 'false');
      soundIcon.textContent = sfx.enabled ? 'üîä' : 'üîá';
      soundLabel.textContent = sfx.enabled ? 'Sound' : 'Muted';
    }
    soundToggle.addEventListener('click', async ()=>{
      await sfx.resume();
      sfx.setEnabled(!sfx.enabled);
      updateSoundUI();
      if(sfx.enabled) sfx.play('ui');
    });
    function updateVibeUI(){
      vibeToggle.setAttribute('aria-pressed', haptics.enabled ? 'true' : 'false');
    }
    vibeToggle.addEventListener('click', ()=>{
      haptics.set(!haptics.enabled);
      updateVibeUI();
      if(haptics.enabled) haptics.light();
    });

    // Keep input focus for desktop keyboards
    function focusHiddenInput(){
      if(window.innerWidth > 820){
        hiddenInput.focus({preventScroll:true});
      }
    }

    // Initialize
    (function init(){
      updateSoundUI();
      updateVibeUI();
      streakEl.textContent = String(streak || 0);
      resetState();
    })();
  </script>
</body>
</html>