<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Division Fun ‚ûó</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#7bd3ff;
      --bg2:#feb5f9;
      --bg3:#fff09a;
      --card:#ffffffee;
      --text:#1a1a1a;
      --muted:#5a6a7b;
      --good:#18c37f;
      --bad:#ff4d6d;
      --btn1:#6d8cff;
      --btn2:#ff8ccf;
      --btn3:#ffd36e;
      --btn4:#5ee0a0;
      --shadow:0 14px 30px rgba(0,0,0,.18);
      --radius:22px;
      --tap:72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Fredoka",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;
      color:var(--text);
      background: radial-gradient(140vmax 80vmax at 20% 10%, var(--bg1), transparent 60%),
                  radial-gradient(120vmax 90vmax at 80% 0%, var(--bg2), transparent 55%),
                  radial-gradient(120vmax 100vmax at 50% 100%, var(--bg3), transparent 60%),
                  linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3));
      background-size: 200% 200%;
      animation: bgMove 12s ease-in-out infinite;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }
    @keyframes bgMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .floaters{
      position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden;
    }
    .floater{
      position:absolute;
      width:clamp(60px,14vw,140px);
      aspect-ratio:1/1;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.2) 55%, rgba(255,255,255,0));
      filter: blur(1px);
      opacity:.35;
      animation: drift var(--dur) linear infinite;
      will-change: transform;
      mix-blend-mode: screen;
    }
    @keyframes drift{
      from{ transform: translate3d(var(--x), 110vh, 0) rotate(0deg) scale(var(--s)) }
      to{ transform: translate3d(calc(var(--x) + var(--dx)), -20vh, 0) rotate(var(--rot)) scale(var(--s)) }
    }

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap:16px;
      padding:16px;
      align-items:center;
      justify-content:center;
      position:relative;
      z-index:1;
    }
    .topbar{
      width:min(740px,96vw);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 6px;
      gap:8px;
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:clamp(22px,5vw,34px);
      color:#0b2450;
      text-shadow:0 2px 0 rgba(255,255,255,.6);
      letter-spacing:.5px;
    }
    .title .logo{
      display:inline-grid; place-items:center;
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg,#6d8cff,#a35dfc);
      box-shadow: 0 6px 14px rgba(109,140,255,.35), inset 0 -2px 0 rgba(0,0,0,.08);
      color:#fff; font-size:22px;
    }
    .controls{
      display:flex;
      gap:8px;
    }
    .ctrl-btn{
      border:none;
      border-radius:16px;
      padding:12px 14px;
      min-width:56px;
      font-weight:700;
      font-size:18px;
      background:#ffffffaa;
      backdrop-filter:blur(6px);
      box-shadow:var(--shadow);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:transform .08s ease, background .2s ease, filter .2s ease;
      touch-action: manipulation;
    }
    .ctrl-btn:active{ transform: scale(.96) }
    .ctrl-btn span{ font-size:22px }
    .card{
      width:min(740px,96vw);
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 22px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .hint{
      font-size:clamp(16px,3.8vw,20px);
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .problem{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      border-radius:18px;
      background:linear-gradient(135deg,#fff, #f7fcff);
      padding:14px 10px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.04);
      position:relative;
      overflow:hidden;
    }
    .problem::after{
      content:'';
      position:absolute; inset:auto -20% 0 -20%;
      height:10px; background:linear-gradient(90deg,#9ec8ff44,#ffa9e644,#fff09a44);
      filter:blur(10px);
    }
    .expr{
      font-size:clamp(36px,10vw,66px);
      font-weight:800;
      letter-spacing:1px;
      background: linear-gradient(90deg,#2a36a5,#a71eb5);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      text-align:center;
      line-height:1.1;
      user-select:none;
    }
    .streak{
      align-self:center;
      background:#fff7ca;
      color:#7a5a00;
      border-radius:999px;
      padding:8px 14px;
      font-weight:700;
      font-size:clamp(16px,4vw,18px);
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 6px 14px rgba(255,215,64,.35), inset 0 -2px 0 rgba(0,0,0,.06);
    }
    .opts{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin-top:4px;
    }
    @media (min-width:720px){
      .opts{ grid-template-columns:repeat(4,1fr) }
    }
    .btn{
      position:relative;
      border:none;
      border-radius:20px;
      padding:18px;
      min-height:var(--tap);
      font-weight:800;
      font-size:clamp(24px,6vw,34px);
      color:#10223a;
      cursor:pointer;
      box-shadow: var(--shadow);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      user-select:none;
      touch-action: manipulation;
      outline-offset: 4px;
    }
    .btn:active{ transform: scale(.97) }
    .btn[data-idx="0"]{ background:linear-gradient(135deg,#c6d1ff,#8fb0ff) }
    .btn[data-idx="1"]{ background:linear-gradient(135deg,#ffc1e8,#ff9bd6) }
    .btn[data-idx="2"]{ background:linear-gradient(135deg,#ffe8a6,#ffd36e) }
    .btn[data-idx="3"]{ background:linear-gradient(135deg,#b6ffd8,#5ee0a0) }
    .btn .emoji{
      font-size:clamp(26px,6vw,34px);
      filter: drop-shadow(0 2px 0 rgba(255,255,255,.7));
    }
    .btn.good{
      animation: popGood .6s ease both;
      box-shadow: 0 0 0 6px rgba(24,195,127,.25), var(--shadow);
    }
    @keyframes popGood{
      0%{ transform:scale(1) }
      30%{ transform:scale(1.08) }
      60%{ transform:scale(.98) }
      100%{ transform:scale(1) }
    }
    .btn.bad{
      animation: shake .45s ease both;
      box-shadow: 0 0 0 6px rgba(255,77,109,.25), var(--shadow);
      filter: saturate(1.1);
    }
    @keyframes shake{
      0%,100%{ transform:translateX(0) }
      20%{ transform:translateX(-8px) }
      40%{ transform:translateX(8px) }
      60%{ transform:translateX(-6px) }
      80%{ transform:translateX(6px) }
    }
    .flash{
      position:absolute;
      inset:0;
      border-radius:inherit;
      background:rgba(255,255,255,.35);
      animation: flash .35s ease both;
      pointer-events:none;
    }
    @keyframes flash{
      from{ opacity:1 }
      to{ opacity:0 }
    }
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:linear-gradient(120deg,rgba(255,255,255,.85),rgba(255,255,255,.6));
      backdrop-filter: blur(6px);
      z-index:20;
    }
    .overlay.show{ display:flex }
    .count{
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .count .num{
      font-size:clamp(64px,18vw,120px);
      font-weight:900;
      line-height:1;
      color:#0b2450;
      text-shadow:0 4px 0 rgba(255,255,255,.7);
      animation: bounce .6s ease;
      user-select:none;
    }
    .count .yay{
      font-size:clamp(28px,6vw,34px);
      color:#045a3a;
      font-weight:800;
      background:#dffbea;
      padding:8px 16px;
      border-radius:999px;
      box-shadow: inset 0 -2px 0 rgba(0,0,0,.06);
    }
    @keyframes bounce{
      0%{ transform:scale(.5); opacity:0 }
      60%{ transform:scale(1.1); opacity:1 }
      100%{ transform:scale(1) }
    }
    .confetti{
      position:fixed;
      top:0; left:0;
      pointer-events:none;
      z-index:30;
      font-size:26px;
      animation: fall 900ms ease-out forwards;
      will-change: transform, opacity;
    }
    @keyframes fall{
      0%{ transform: translate(var(--x), var(--y)) scale(1); opacity:1 }
      100%{ transform: translate(calc(var(--x) + var(--dx)), calc(var(--y) + var(--dy))) rotate(var(--rot)); opacity:0 }
    }
    .sr-only{
      position:absolute!important;
      width:1px;height:1px;
      padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);
      white-space:nowrap;border:0;
    }
    .swipe-tip{
      position:absolute; right:10px; top:10px;
      background:#ffffffd9; padding:6px 10px; border-radius:12px; font-weight:700; color:#305; font-size:14px;
      box-shadow:var(--shadow);
      opacity:0; transform: translateX(10px);
      transition: opacity .3s ease, transform .3s ease;
      pointer-events:none;
    }
    .swipe-tip.show{ opacity:1; transform: translateX(0) }
    @media (prefers-reduced-motion: reduce){
      *{ animation:none!important; transition:none!important }
    }
  </style>
</head>
<body>
  <div class="floaters" aria-hidden="true">
    <span class="floater" style="--x:5vw; --dx:10vw; --rot:40deg; --dur:18s; --s:.9"></span>
    <span class="floater" style="--x:25vw; --dx:-6vw; --rot:-60deg; --dur:22s; --s:.7"></span>
    <span class="floater" style="--x:55vw; --dx:8vw; --rot:80deg; --dur:26s; --s:1"></span>
    <span class="floater" style="--x:75vw; --dx:-12vw; --rot:-100deg; --dur:20s; --s:.8"></span>
    <span class="floater" style="--x:90vw; --dx:-4vw; --rot:120deg; --dur:28s; --s:1.1"></span>
  </div>

  <div class="wrap">
    <div class="topbar" aria-label="Game controls">
      <div class="title" aria-hidden="true"><span class="logo">‚ûó</span> Division Fun!</div>
      <div class="controls">
        <button class="ctrl-btn" id="sfxBtn" aria-pressed="true" aria-label="Toggle sound effects">
          <span id="sfxIcon">üîà</span><b>Sound</b>
        </button>
        <button class="ctrl-btn" id="voiceBtn" aria-pressed="true" aria-label="Toggle voice">
          <span id="voiceIcon">üîä</span>
          <b>Voice</b>
        </button>
        <button class="ctrl-btn" id="repeatBtn" aria-label="Repeat question">
          <span>üîÅ</span><b>Repeat</b>
        </button>
        <button class="ctrl-btn" id="skipBtn" aria-label="Skip question">
          <span>‚è≠Ô∏è</span><b>Skip</b>
        </button>
      </div>
    </div>

    <div class="card" role="group" aria-label="Math question" id="card">
      <div class="hint">üëâ Tap an answer ‚Ä¢ Tip: swipe left/right to skip ‚Ä¢ Double-tap the question to hear it</div>
      <div class="problem" id="problem">
        <div class="expr" id="expr" aria-live="polite">8 √∑ 2 = ?</div>
        <div class="swipe-tip" id="swipeTip">‚ü∑ Swipe to skip</div>
      </div>
      <div class="streak" id="streak" aria-live="polite">üåà Streak: 0</div>
      <div class="opts" id="opts" role="listbox" aria-label="Choices"></div>
    </div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-live="polite">
    <div class="count">
      <div class="yay" id="yay">üåü Great job!</div>
      <div class="num" id="num">3Ô∏è‚É£</div>
    </div>
  </div>

  <div class="sr-only" aria-live="polite" id="live"></div>

  <script>
    // State
    const state = {
      a:0,b:0,answer:0,locked:false,streak:0,
      voiceOn: JSON.parse(localStorage.getItem('voiceOn') ?? 'true'),
      sfxOn: JSON.parse(localStorage.getItem('sfxOn') ?? 'true')
    };

    // Elements
    const exprEl = document.getElementById('expr');
    const optsEl = document.getElementById('opts');
    const overlay = document.getElementById('overlay');
    const numEl = document.getElementById('num');
    const yayEl = document.getElementById('yay');
    const streakEl = document.getElementById('streak');
    const voiceBtn = document.getElementById('voiceBtn');
    const voiceIcon = document.getElementById('voiceIcon');
    const skipBtn = document.getElementById('skipBtn');
    const sfxBtn = document.getElementById('sfxBtn');
    const sfxIcon = document.getElementById('sfxIcon');
    const repeatBtn = document.getElementById('repeatBtn');
    const live = document.getElementById('live');
    const problem = document.getElementById('problem');
    const card = document.getElementById('card');
    const swipeTip = document.getElementById('swipeTip');

    let countdownTimer = null;
    const prefersReducedMotion = matchMedia('(prefers-reduced-motion: reduce)').matches;

    const emojiNumbers = ["3Ô∏è‚É£","2Ô∏è‚É£","1Ô∏è‚É£","üöÄ"];
    const btnEmojis = ["üê£","üß©","üç¨","‚≠ê"];
    const confettiPool = ["üéâ","‚ú®","üéà","üåü","üí´","‚≠ê","üéä"];

    // Utility
    const randint = (n,m)=> Math.floor(Math.random()*(m-n+1))+n;
    const sample = (arr)=> arr[randint(0, arr.length-1)];
    function shuffleFisherYates(array){
      const a = array.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // Speech
    function speak(t){
      try{
        if(!state.voiceOn || !('speechSynthesis' in window)) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(String(t));
        u.lang='en-US';
        u.rate=1.0;
        u.pitch=1.1;
        window.speechSynthesis.speak(u);
      }catch(_){}
    }

    function vibrate(ms){
      if('vibrate' in navigator){ try{ navigator.vibrate(ms); }catch(_){} }
    }

    // Sound effects (WebAudio)
    const Sound = (()=> {
      let ctx = null, master = null;
      const ensure = ()=>{
        if(ctx) return;
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        master = ctx.createGain();
        master.gain.value = state.sfxOn ? 0.5 : 0.0;
        master.connect(ctx.destination);
      };
      const setEnabled = (on)=>{
        ensure();
        master.gain.cancelScheduledValues(ctx.currentTime);
        master.gain.setTargetAtTime(on?0.5:0.0001, ctx.currentTime, 0.02);
      };
      function tone(freq, dur=0.15, type='sine', vol=0.5, t0){
        ensure();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        o.connect(g); g.connect(master);
        const now = t0 ?? ctx.currentTime;
        const attack = 0.01, release = Math.max(0.04, dur*0.4);
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(vol, now+attack);
        g.gain.exponentialRampToValueAtTime(0.0001, now+dur+release);
        o.start(now);
        o.stop(now+dur+release+0.05);
        return now+dur+release;
      }
      function click(){
        ensure(); if(!state.sfxOn) return;
        const now = ctx.currentTime;
        tone(220, 0.05, 'sine', 0.25, now);
        tone(440, 0.03, 'sine', 0.2, now+0.03);
      }
      function correct(){
        ensure(); if(!state.sfxOn) return;
        const now = ctx.currentTime;
        let t = now;
        t = tone(523.25, 0.12, 'sine', 0.35, t);
        t = tone(659.25, 0.12, 'sine', 0.35, t-0.06);
        tone(783.99, 0.18, 'sine', 0.35, t-0.06);
      }
      function wrong(){
        ensure(); if(!state.sfxOn) return;
        const now = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(240, now);
        o.frequency.exponentialRampToValueAtTime(90, now+0.25);
        g.gain.setValueAtTime(0.001, now);
        g.gain.exponentialRampToValueAtTime(0.35, now+0.02);
        g.gain.exponentialRampToValueAtTime(0.001, now+0.35);
        o.connect(g); g.connect(master);
        o.start(now); o.stop(now+0.36);
      }
      function tick(){
        ensure(); if(!state.sfxOn) return;
        tone(880, 0.08, 'square', 0.25);
      }
      function whoosh(){
        ensure(); if(!state.sfxOn) return;
        const now = ctx.currentTime;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'triangle';
        o.frequency.setValueAtTime(220, now);
        o.frequency.exponentialRampToValueAtTime(880, now+0.35);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.exponentialRampToValueAtTime(0.35, now+0.04);
        g.gain.exponentialRampToValueAtTime(0.0001, now+0.4);
        o.connect(g); g.connect(master);
        o.start(now); o.stop(now+0.42);
      }
      return { ensure, setEnabled, click, correct, wrong, tick, whoosh };
    })();

    // Question generation
    function newQuestion(){
      state.locked = false;
      const m = randint(2,9), n = randint(2,9);
      if(Math.random() < 0.5){ state.a = m*n; state.b = m; } else { state.a = m*n; state.b = n; }
      state.answer = state.a / state.b;

      exprEl.textContent = `${state.a} √∑ ${state.b} = ?`;
      exprEl.style.animation = 'bounce .5s ease';
      setTimeout(()=> exprEl.style.animation = '', 520);

      const options = sampleOptions(state.answer);
      renderOptions(options);
      speakQuestion();
    }

    function sampleOptions(answer){
      const set = new Set([answer]);
      const options = [answer];
      const candidates = [];
      for(let d=1; d<=5; d++) { candidates.push(answer+d, Math.max(0,answer-d)); }
      while(options.length < 4){
        let v;
        if(candidates.length && Math.random()<0.7){
          v = candidates.splice(randint(0,candidates.length-1),1)[0];
        }else{
          v = randint(Math.max(0,answer-7), answer+7);
        }
        if(Number.isFinite(v) && v>=0 && !set.has(v)){
          set.add(v); options.push(v);
        }
      }
      return shuffleFisherYates(options);
    }

    function renderOptions(options){
      const frag = document.createDocumentFragment();
      optsEl.innerHTML = '';
      options.forEach((v, i)=>{
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.type = 'button';
        btn.setAttribute('role','option');
        btn.setAttribute('aria-label', `Answer ${v}`);
        btn.dataset.idx = i;
        btn.dataset.val = String(v);
        btn.dataset.key = String(i+1);
        btn.innerHTML = `<span class="emoji">${btnEmojis[i%btnEmojis.length]}</span> <span class="val">${v}</span> <span class="sr-only">Press ${i+1}</span>`;
        frag.appendChild(btn);
      });
      optsEl.appendChild(frag);
    }

    // Interactions
    optsEl.addEventListener('click', (e)=>{
      const target = e.target.closest('.btn');
      if(!target) return;
      Sound.click();
      pick(target, Number(target.dataset.val));
    }, { passive:true });

    function pick(btn, v){
      if(state.locked) return;
      state.locked = true;

      const flash = document.createElement('div');
      flash.className = 'flash';
      btn.appendChild(flash);

      if(v === state.answer){
        btn.classList.add('good');
        state.streak++;
        updateStreak();
        celebration(btn);
        speak('Correct! Yay!');
        Sound.correct();
        vibrate(80);
        if(prefersReducedMotion){
          setTimeout(nextQuestion, 450);
        }else{
          setTimeout(()=> showCountdown(nextQuestion), 650);
        }
      }else{
        btn.classList.add('bad');
        state.streak = 0;
        updateStreak();
        popEmoji(btn, '‚ùå');
        speak('Try again!');
        Sound.wrong();
        vibrate([30,40,30]);
        setTimeout(()=>{ btn.classList.remove('bad'); state.locked=false; }, 450);
      }
    }

    function updateStreak(){
      streakEl.textContent = `üåà Streak: ${state.streak}`;
      live.textContent = `Streak ${state.streak}`;
    }

    function popEmoji(el, ch){
      const rect = el.getBoundingClientRect();
      const span = document.createElement('span');
      span.textContent = ch;
      span.style.position='fixed';
      span.style.left = (rect.left + rect.width/2 - 12) + 'px';
      span.style.top = (rect.top - 10) + 'px';
      span.style.fontSize='28px';
      span.style.zIndex='15';
      span.style.transition='transform .6s ease, opacity .6s ease';
      span.style.transform='translateY(0)';
      span.style.opacity='1';
      document.body.appendChild(span);
      requestAnimationFrame(()=>{
        span.style.transform='translateY(-22px) scale(1.2)';
        span.style.opacity='0';
      });
      setTimeout(()=> span.remove(), 620);
    }

    function celebration(btn){
      const rect = btn.getBoundingClientRect();
      const x = rect.left + rect.width/2;
      const y = rect.top + rect.height/2;
      for(let i=0;i<18;i++){
        const s = document.createElement('span');
        s.className='confetti';
        s.textContent = sample(confettiPool);
        s.style.left = '0px'; s.style.top='0px';
        s.style.setProperty('--x', x+'px');
        s.style.setProperty('--y', y+'px');
        const dx = (Math.random()*2-1)*160;
        const dy = (Math.random()*-1)*220 - 80;
        const rot = (Math.random()*2-1)*180+'deg';
        s.style.setProperty('--dx', dx+'px');
        s.style.setProperty('--dy', dy+'px');
        s.style.setProperty('--rot', rot);
        document.body.appendChild(s);
        setTimeout(()=> s.remove(), 950);
      }
      popEmoji(btn, '‚úÖ');
    }

    function showCountdown(done){
      overlay.classList.add('show');
      yayEl.textContent = sample(['üåü Great job!','üéâ Woohoo!','üòÑ You got it!','üëè Nice!']);
      let idx = 0;
      numEl.textContent = emojiNumbers[idx];
      numEl.style.animation = 'bounce .6s ease';
      Sound.tick();
      countdownTimer && clearInterval(countdownTimer);
      countdownTimer = setInterval(()=>{
        idx++;
        if(idx >= emojiNumbers.length){
          clearInterval(countdownTimer);
          Sound.whoosh();
          overlay.classList.remove('show');
          done();
          return;
        }
        numEl.textContent = emojiNumbers[idx];
        numEl.style.animation = 'none';
        void numEl.offsetWidth; // reflow to restart anim
        numEl.style.animation = 'bounce .6s ease';
        Sound.tick();
      }, 650);
    }

    function speakQuestion(){
      speak(`${state.a} divided by ${state.b}. What is the answer?`);
    }

    function nextQuestion(){
      newQuestion();
    }

    // Controls
    voiceBtn.addEventListener('click', ()=>{
      state.voiceOn = !state.voiceOn;
      voiceBtn.setAttribute('aria-pressed', String(state.voiceOn));
      voiceIcon.textContent = state.voiceOn ? 'üîä' : 'üîá';
      localStorage.setItem('voiceOn', JSON.stringify(state.voiceOn));
      vibrate(20);
      Sound.click();
    });

    sfxBtn.addEventListener('click', ()=>{
      state.sfxOn = !state.sfxOn;
      sfxBtn.setAttribute('aria-pressed', String(state.sfxOn));
      sfxIcon.textContent = state.sfxOn ? 'üîà' : 'üîá';
      localStorage.setItem('sfxOn', JSON.stringify(state.sfxOn));
      Sound.setEnabled(state.sfxOn);
      vibrate(16);
      if(state.sfxOn) Sound.click();
    });

    repeatBtn.addEventListener('click', ()=>{
      Sound.click();
      vibrate(16);
      speakQuestion();
    });

    skipBtn.addEventListener('click', ()=>{
      vibrate(30);
      Sound.whoosh();
      speak('Skipping to a new question');
      newQuestion();
    });

    // Swipe to skip + double tap to repeat
    let touchStartX=0, touchStartY=0, touchTime=0, lastTap=0;
    card.addEventListener('touchstart', (e)=>{
      const t = e.changedTouches[0];
      touchStartX = t.clientX; touchStartY = t.clientY; touchTime = Date.now();
    }, { passive:true });
    card.addEventListener('touchend', (e)=>{
      const t = e.changedTouches[0];
      const dx = t.clientX - touchStartX;
      const dy = t.clientY - touchStartY;
      const dt = Date.now() - touchTime;
      const isSwipe = Math.abs(dx) > 70 && Math.abs(dx) > Math.abs(dy) && dt < 500;
      if(isSwipe){
        swipeTip.classList.add('show');
        setTimeout(()=> swipeTip.classList.remove('show'), 1200);
        Sound.whoosh();
        speak('Skipping to a new question');
        newQuestion();
        return;
      }
      // double-tap detect
      const now = Date.now();
      if(now - lastTap < 350){
        Sound.click();
        speakQuestion();
      }
      lastTap = now;
    }, { passive:true });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(e.repeat) return;
      const k = e.key.toLowerCase();
      if(k === 's'){ skipBtn.click(); }
      if(k === 'v'){ voiceBtn.click(); }
      if(k === 'm'){ sfxBtn.click(); }
      if(k === 'r' || k === ' ' || k === 'enter'){ repeatBtn.click(); }
      // number keys 1-4
      if(/^[1-4]$/.test(k)){
        const idx = Number(k)-1;
        const btn = optsEl.querySelector(`.btn[data-idx="${idx}"]`);
        if(btn){ btn.click(); }
      }
    });

    // Ensure UI matches saved settings
    function syncToggles(){
      voiceBtn.setAttribute('aria-pressed', String(state.voiceOn));
      voiceIcon.textContent = state.voiceOn ? 'üîä' : 'üîá';
      sfxBtn.setAttribute('aria-pressed', String(state.sfxOn));
      sfxIcon.textContent = state.sfxOn ? 'üîà' : 'üîá';
      // Prepare audio graph (deferred until first interaction on some browsers)
      try{ Sound.setEnabled(state.sfxOn); }catch(_){}
    }
    syncToggles();

    // Unlock audio on first interaction
    ['pointerdown','touchstart','keydown'].forEach(ev=>{
      window.addEventListener(ev, ()=> { try{ Sound.ensure(); Sound.setEnabled(state.sfxOn); }catch(_){} }, { once:true, passive:true });
    });

    // Initialize
    newQuestion();
  </script>
</body>
</html>